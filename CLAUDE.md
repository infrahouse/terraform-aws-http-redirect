# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this
repository.

## First Steps

**Your first tool call in this repository MUST be reading .claude/CODING_STANDARD.md.
Do not read any other files, search, or take any actions until you have read it.**
This contains InfraHouse's comprehensive coding standards for Terraform, Python, and general formatting rules.

## Project Overview

This is a Terraform module that creates HTTP/HTTPS redirects using AWS CloudFront, S3, ACM, and
Route53. The module handles the entire redirect infrastructure including TLS certificate
provisioning and DNS configuration.

Key AWS resources created:
- CloudFront distribution (TLS termination and redirect execution)
- CloudFront Function (optional, for non-GET method support or custom response headers)
- S3 bucket with website hosting (redirect origin)
- ACM certificate (auto-provisioned in us-east-1)
- Route53 DNS records (A/AAAA aliases to CloudFront)

## Development Commands

### Formatting and Linting
```bash
make format          # Format Terraform and Python (terraform fmt + black)
make lint            # Check Terraform formatting without changes
```

### Testing
```bash
make bootstrap       # Install Python dependencies (pytest-infrahouse, infrahouse-core)
make test            # Run all tests in tests/test_module.py
make test-keep       # Run tests but keep AWS resources after (for debugging)
make test-clean      # Run tests and destroy resources (explicit cleanup)
```

Test configuration:
- Tests use pytest with custom fixtures from `tests/conftest.py`
- Test infrastructure lives in `test_data/main/` directory
- Tests create real AWS resources using the infrahouse-pytest framework
- Default test region: us-east-1
- Default test role: arn:aws:iam::303467602807:role/http-redirect-tester

### Git Hooks
```bash
make install-hooks   # Install pre-commit and commit-msg hooks
```

The repository uses two git hooks (in `hooks/` directory):
1. **pre-commit**: Runs `terraform fmt -check` and updates README.md with terraform-docs
2. **commit-msg**: Enforces Conventional Commits format (feat, fix, docs, security, etc.)

### Documentation
```bash
# README.md is auto-generated by terraform-docs using .terraform-docs.yml
# The pre-commit hook automatically updates it when Terraform files change
terraform-docs .     # Manually regenerate documentation
```

### Version Management
```bash
# This project uses bumpversion for versioning (.bumpversion.cfg)
# Version must be updated in two places:
# - README.md: version = "X.Y.Z"
# - locals.tf: module_version = "X.Y.Z"
```

## Architecture

### Module Structure
- `main.tf` - CloudFront distribution configuration
- `cloudfront-function.tf` - Optional CloudFront Function for non-GET methods and custom headers
- `templates/redirect-all-methods.js.tftpl` - JavaScript template for the CloudFront Function
- `s3.tf` - S3 bucket and website configuration for redirect origin
- `acm.tf` - ACM certificate provisioning and validation (us-east-1 provider)
- `dns.tf` - Route53 A/AAAA records pointing to CloudFront
- `variables.tf` - Module inputs (redirect_hostnames, redirect_to, zone_id, etc.)
- `locals.tf` - Module version, default tags, and `use_cloudfront_function` conditional
- `data-sources.tf` - Route53 zone lookup
- `terraform.tf` - Provider configuration (AWS ~> 5.62)

### Key Implementation Details

**Hostname Resolution Logic** (main.tf:44):
The module constructs full domain names by joining hostname prefixes with the zone name, handling
both apex domains (empty string) and subdomains:
```hcl
for record in var.redirect_hostnames : trimprefix(join(".", [record, data.aws_route53_zone.redirect.name]), ".")
```
This allows `redirect_hostnames = ["", "www"]` to create both apex and www redirects.

**ACM Certificate Requirements**:
CloudFront requires ACM certificates in us-east-1 region. The module must ensure the ACM provider
is configured for us-east-1 regardless of where other resources are created.

**S3 Website Redirect**:
The S3 bucket is configured as a static website with redirect rules, and CloudFront uses it as a
custom origin (not S3 origin) to preserve the HTTP redirect behavior.

**CloudFront Behavior**:
- Uses `viewer_protocol_policy = "redirect-to-https"` to force HTTPS
- Forwards query strings to preserve them during redirect
- Uses `default_cache_behavior` to cache redirect responses

**CloudFront Function** (`cloudfront-function.tf`):
An optional CloudFront Function is deployed when `local.use_cloudfront_function` is true, which
happens when either `allow_non_get_methods = true` or `response_headers` is non-empty. The function:
- Intercepts requests at the viewer-request stage (before reaching S3 origin)
- Returns redirect responses directly (S3 is never reached)
- Uses 308/307 status codes for non-GET/HEAD methods to preserve HTTP method and body
- Uses 301/302 for GET/HEAD (controlled by `permanent_redirect` variable)
- Adds custom response headers from `var.response_headers`
- Reconstructs query strings from CloudFront's structured querystring object

The JavaScript source lives in `templates/redirect-all-methods.js.tftpl` and is rendered via
`templatefile()` with variables: `redirect_hostname`, `redirect_path`, `get_head_status_code`,
`other_status_code`, and `response_headers`.

When neither condition is met, the module uses the default S3 website hosting redirect path
(GET-only, 301 responses).

### Testing Architecture

Tests follow the infrahouse-pytest pattern:
1. Generate `terraform.tfvars` with test parameters (region, zone, role)
2. Use `terraform_apply` context manager to create resources
3. Validate HTTP 301 redirects work correctly
4. Automatically destroy resources unless `--keep-after` is specified

The `test_data/main/` directory contains a test fixture that consumes the module with test
parameters.

## Conventional Commits

All commit messages must follow the Conventional Commits specification:
- `feat:` - New features
- `fix:` - Bug fixes
- `docs:` - Documentation changes
- `security:` - Security improvements
- `refactor:` - Code refactoring
- `test:` - Test changes
- `chore:` - Maintenance tasks
- `ci:` - CI/CD changes

Use `!` suffix for breaking changes: `feat!: remove deprecated variable`

## CI/CD

The repository includes GitHub Actions workflows:
- `terraform-CI.yml` - Continuous integration (lint, test)
- `terraform-CD.yml` - Continuous deployment (publish module)
- `terraform-review.yml` - PR review automation
- `vuln-scanner-pr.yml` - Security vulnerability scanning

Renovate is configured but has GitHub Actions updates disabled.

## Important Notes

- ACM certificates MUST be in us-east-1 for CloudFront compatibility
- S3 bucket names are derived from hostnames and must be globally unique
- Default redirects are HTTP 301 (permanent); set `permanent_redirect = false` for 302/307
- Non-GET methods (POST, PUT, DELETE, PATCH) use 308/307 to preserve method and body
- Query strings and paths are preserved during redirects
- The module requires an existing Route53 hosted zone (passed via zone_id)
- Changes to README.md should not be made manually - use terraform-docs instead
- Setting `response_headers` or `allow_non_get_methods` deploys a CloudFront Function
