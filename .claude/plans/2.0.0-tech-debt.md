# 2.0.0 Release Plan - Tech Debt from 1.3.2

## Background

On 2026-02-21, deploying a second http-redirect instance in the same AWS
account failed due to name collisions in three resources (S3 logs bucket,
CloudFront cache policy, CloudFront response headers policy). Version
1.3.2 was a hotfix committed directly to main without tests.

The fix is correct (random suffix in resource names) but constitutes a
breaking change: upgrading from 1.3.x destroys the logs bucket, causing
data loss. This must be released as 2.0.0 with proper test coverage and
a migration guide.

## Tasks

### 1. Commit the `depends_on` race condition fix

**File**: `main.tf:124-125`

The working tree contains an uncommitted fix for a race condition hit
during the incident:

```hcl
depends_on = [module.cloudfront_logs_bucket]
```

CloudFront tried to use the logging bucket before ACLs were ready,
producing:

```
The S3 bucket that you specified for CloudFront logs does not enable
ACL access
```

This fix must be committed and included in 2.0.0.

### 2. Add multi-instance test

**The original bug has no test coverage.** Two module instances in the
same account caused name collisions. A test must verify the fix works.

Create:
- `test_data/multi_instance/main.tf` - two module instances in one zone
- `test_data/multi_instance/variables.tf`
- `test_data/multi_instance/outputs.tf`
- `test_data/multi_instance/providers.tf` (copy from test_data/main/)
- `test_data/multi_instance/datasources.tf`

Add `test_multi_instance()` to `tests/test_module.py`:
- Parametrize on aws_provider_version (5, 6)
- Instance 1: redirect_hostnames=["multi1"], redirect_to=target_a
- Instance 2: redirect_hostnames=["multi2"], redirect_to=target_b
- Verify both CloudFront distributions work independently
- Verify no name collisions in policies or buckets

### 3. Update CHANGELOG.md

Current 1.3.2 entry:

```
## [1.3.2] - 2026-02-21
### Bug Fixes
- Use random suffix in resource names to support multiple module instances
```

Must note:
- This is a **breaking change** (logs bucket renamed, data loss on
  naive upgrade)
- New `hashicorp/random` provider dependency
- Race condition fix (`depends_on` for CloudFront logs bucket)
- Link to `docs/upgrading.md` for migration instructions

### 4. Create `docs/upgrading.md`

Done - see `docs/upgrading.md` in this repository.

### 5. Update `mkdocs.yml`

Add `upgrading.md` to the nav section.

### 6. Bump version to 2.0.0

**After merging to main**, run `make release-major` on main. This
updates version references in 11 files via bumpversion, creates a
tag, and must be done from the main branch.

## Verification

1. `make format` - clean formatting
2. `make lint` - passes
3. `make test` - all tests pass including new `test_multi_instance`
4. Review `docs/upgrading.md` for completeness
5. Manual `terraform plan` against a real 1.3.1 deployment to confirm
   the migration guide matches reality
